jQuery(function ($) {
  function resize_calendar($calendars_wrapper) {
    var $months_wrapper = $calendars_wrapper.find(".wpsbc-calendars-wrapper"),
      $months_wrapper_width = $calendars_wrapper.find(".wpsbc-calendars"),
      calendar_min_width = $calendars_wrapper.data("min_width"),
      calendar_max_width = $calendars_wrapper.data("max_width"),
      $month_inner = $calendars_wrapper.find(".wpsbc-calendar-wrapper");
    $calendars_wrapper.data("min_width") > 0 &&
      $calendars_wrapper
        .find(".wpsbc-calendar")
        .css("min-width", calendar_min_width),
      $calendars_wrapper.data("max_width") > 0 &&
        $calendars_wrapper
          .find(".wpsbc-calendar")
          .css("max-width", calendar_max_width);
    var column_count = 0;
    (column_count =
      $months_wrapper_width.width() < 2 * (10 + calendar_min_width)
        ? 1
        : $months_wrapper_width.width() < 3 * (10 + calendar_min_width)
        ? 2
        : $months_wrapper_width.width() < 4 * (10 + calendar_min_width)
        ? 3
        : $months_wrapper_width.width() < 6 * (10 + calendar_min_width)
        ? 4
        : 6),
      $calendars_wrapper.find(".wpsbc-calendar").length <= column_count &&
        (column_count = $calendars_wrapper.find(".wpsbc-calendar").length),
      $calendars_wrapper.attr("data-columns", column_count),
      $months_wrapper.hasClass("wpsbc-legend-position-side") &&
        ($months_wrapper.css("max-width", "none"),
        $months_wrapper.css(
          "max-width",
          $calendars_wrapper.find(".wpsbc-calendar").first().outerWidth(!0) *
            column_count
        ));
    var td_width = $calendars_wrapper.find("td").first().width();
    $calendars_wrapper
      .find("td .wpsbc-date-inner, td .wpsbc-week-number")
      .css("height", Math.ceil(td_width) + 1 + "px"),
      $calendars_wrapper
        .find("td .wpsbc-date-inner, td .wpsbc-week-number")
        .css("line-height", Math.ceil(td_width) + 1 + "px");
    var th_height = $calendars_wrapper
      .find("th")
      .css("height", "auto")
      .first()
      .height();
    $calendars_wrapper
      .find("th")
      .css("height", Math.ceil(th_height) + 1 + "px");
    var calendar_month_height = 0;
    $month_inner.css("min-height", "1px"),
      $month_inner.each(function () {
        $(this).height() >= calendar_month_height &&
          (calendar_month_height = $(this).height());
      }),
      $month_inner.css("min-height", Math.ceil(calendar_month_height) + "px"),
      $calendars_wrapper.css("visibility", "visible");
  }
  function resize_calendar_overview($calendar_container) {
    $calendar_container
      .find(".wpsbc-overview-row .wpsbc-overview-row-header")
      .each(function () {
        $(this)
          .parent()
          .find(".wpsbc-calendar-wrapper .wpsbc-date")
          .css(
            "min-height",
            $(this).find(".wpsbc-overview-row-header-inner").outerHeight(!0)
          )
          .css(
            "line-height",
            $(this).find(".wpsbc-overview-row-header-inner").outerHeight(!0) +
              "px"
          );
      });
  }
  function refresh_calendar($calendar_container, current_year, current_month) {
    var $calendar_container;
    if (
      ($calendar_container = $calendar_container).hasClass("wpsbc-is-loading")
    )
      return !1;
    var data = $calendar_container.data();
    (data.action = "wpsbc_refresh_calendar"),
      (data.current_year = current_year),
      (data.current_month = current_month),
      $calendar_container
        .find(".wpsbc-calendar")
        .append(
          '<div class="wpsbc-overlay"><div class="wpsbc-overlay-spinner"><div class="wpsbc-overlay-bounce1"></div><div class="wpsbc-overlay-bounce2"></div><div class="wpsbc-overlay-bounce3"></div></div></div>'
        ),
      $calendar_container.addClass("wpsbc-is-loading"),
      $calendar_container.find("select").attr("disabled", !0),
      $.post(wpsbc.ajax_url, data, function (response) {
        $calendar_container.replaceWith(response),
          $(".wpsbc-container").each(function () {
            resize_calendar($(this));
          });
      });
  }
  function refresh_calendar_overview(
    $calendar_container,
    current_year,
    current_month
  ) {
    var $calendar_container;
    if (
      ($calendar_container = $calendar_container).hasClass("wpsbc-is-loading")
    )
      return !1;
    var data = $calendar_container.data();
    (data.action = "wpsbc_refresh_calendar_overview"),
      (data.current_year = current_year),
      (data.current_month = current_month),
      $calendar_container
        .find(".wpsbc-overview-inner")
        .append(
          '<div class="wpsbc-overlay"><div class="wpsbc-overlay-spinner"><div class="wpsbc-overlay-bounce1"></div><div class="wpsbc-overlay-bounce2"></div><div class="wpsbc-overlay-bounce3"></div></div></div>'
        ),
      $calendar_container.addClass("wpsbc-is-loading"),
      $calendar_container.find("select").attr("disabled", !0),
      $.post(wpsbc.ajax_url, data, function (response) {
        $calendar_container.replaceWith(response),
          $(".wpsbc-overview-container").each(function () {
            resize_calendar_overview($(this));
          });
      });
  }
  $(".wpsbc-container").each(function () {
    resize_calendar($(this));
  }),
    $(window).on("resize", function () {
      $(".wpsbc-container").each(function () {
        resize_calendar($(this));
      });
    }),
    $(document).on("click", ".wpsbc-container .wpsbc-prev", function (e) {
      e.preventDefault();
      var $container = $(this).closest(".wpsbc-container"),
        current_month = $container.data("current_month"),
        current_year = $container.data("current_year"),
        navigate_count = 1;
      void 0 !== $container.data("jump_months") &&
        "1" == $container.data("jump_months") &&
        (navigate_count = parseInt(
          wpsbc.calendar_months_to_jump
            ? wpsbc.calendar_months_to_jump
            : $container.data("months_to_show")
        ));
      for (var i = 1; i <= navigate_count; i++)
        (current_month -= 1) < 1 && ((current_month = 12), (current_year -= 1));
      refresh_calendar($container, current_year, current_month);
    }),
    $(document).on("click", ".wpsbc-container .wpsbc-next", function (e) {
      e.preventDefault();
      var $container = $(this).closest(".wpsbc-container"),
        current_month = $container.data("current_month"),
        current_year = $container.data("current_year"),
        navigate_count = 1;
      void 0 !== $container.data("jump_months") &&
        "1" == $container.data("jump_months") &&
        (navigate_count = parseInt(
          wpsbc.calendar_months_to_jump
            ? wpsbc.calendar_months_to_jump
            : $container.data("months_to_show")
        ));
      for (var i = 1; i <= navigate_count; i++)
        (current_month += 1) > 12 && ((current_month = 1), (current_year += 1));
      refresh_calendar($container, current_year, current_month);
    }),
    $(document).on(
      "change",
      ".wpsbc-container .wpsbc-select-container select",
      function () {
        var $container = $(this).closest(".wpsbc-container"),
          date = new Date(1e3 * $(this).val()),
          year,
          month;
        refresh_calendar($container, date.getFullYear(), date.getMonth() + 1);
      }
    ),
    $(document).on(
      "change",
      ".wpsbc-overview-container .wpsbc-select-container select",
      function () {
        var $container = $(this).closest(".wpsbc-overview-container"),
          date = new Date(1e3 * $(this).val()),
          year,
          month;
        refresh_calendar_overview(
          $container,
          date.getFullYear(),
          date.getMonth() + 1
        );
      }
    ),
    $(document).on(
      "mouseenter touchstart",
      ".wpsbc-container .wpsbc-date, .wpsbc-overview-container .wpsbc-date",
      function () {
        var $date = $(this);
        if ($date.find(".wpsbc-tooltip").length) {
          var $tooltip = $date.find(".wpsbc-tooltip"),
            offset_left,
            overflow_right =
              $(window).width() -
              ($date.offset().left + $tooltip.outerWidth(!0));
          overflow_right < 0
            ? ((overflow_left =
                0 - ($tooltip.outerWidth(!0) - $date.offset().left)),
              (offset_left =
                overflow_left < 0 && overflow_right > overflow_left
                  ? $date.offset().left
                  : $date.offset().left -
                    $tooltip.outerWidth(!0) +
                    $date.outerWidth(!0)))
            : (offset_left = $date.offset().left),
            $tooltip.css("left", offset_left),
            $tooltip.css(
              "top",
              $date.offset().top -
                $tooltip.outerHeight() -
                $(window).scrollTop() -
                2
            ),
            $date.addClass("wpsbc-tooltip-active");
        }
      }
    ),
    $(window).on("scroll", function () {
      $(".wpsbc-tooltip-active").length &&
        $(".wpsbc-tooltip-active").removeClass("wpsbc-tooltip-active");
    }),
    $(document).on(
      "mouseleave",
      ".wpsbc-container .wpsbc-date, .wpsbc-overview-container .wpsbc-date",
      function () {
        var $date = $(this);
        $date.find(".wpsbc-tooltip").length &&
          $date.removeClass("wpsbc-tooltip-active");
      }
    ),
    $(".wpsbc-overview-container").each(function () {
      resize_calendar_overview($(this));
    }),
    $(window).on("resize", function () {
      $(".wpsbc-overview-container").each(function () {
        resize_calendar_overview($(this));
      });
    });
  var wpsbc_frontend_visible_calendars = $(".wpsbc-container:visible").length;
  function wpsbc_check_if_calendar_is_visible() {
    return (
      !!$(".wpsbc-container").length &&
      ($(".wpsbc-container:visible").addClass("wpsbc-visible"),
      wpsbc_frontend_visible_calendars !=
        $(".wpsbc-container.wpsbc-visible").length &&
        ($(window).trigger("resize"),
        (wpsbc_frontend_visible_calendars = $(
          ".wpsbc-container.wpsbc-visible"
        ).length)),
      $(".wpsbc-container:not(:visible)").removeClass("wpsbc-visible"),
      $(".wpsbc-container.wpsbc-visible").length !=
        $(".wpsbc-container").length &&
        void setTimeout(wpsbc_check_if_calendar_is_visible, 250))
    );
  }
  function wpsbc_search_widget_add_padding() {
    $(".wpsbc-search-widget .wpsbc-search-widget-form").css(
      "padding-right",
      $(
        ".wpsbc-search-widget .wpsbc-search-widget-form .wpsbc-search-widget-field.wpsbc-search-widget-field-submit"
      ).width()
    );
  }
  function wpsbc_search_results_widget_add_padding() {
    $(".wpsbc-search-widget-results-wrap .wpsbc-search-widget-result").each(
      function () {
        ($result = $(this)),
          $result.css(
            "padding-right",
            $result.find(".wpsbc-search-widget-result-button").outerWidth(!0) +
              40
          );
      }
    );
  }
  function wpsbc_search_widget_size() {
    $(".wpsbc-search-widget").each(function () {
      ($widget = $(this)),
        $widget.width() < 500
          ? $widget.addClass("small")
          : $widget.removeClass("small");
    });
  }
  wpsbc_check_if_calendar_is_visible(),
    $(document).ready(function () {
      wpsbc_search_widget_initialize_datepickers(),
        wpsbc_search_widget_pagination(),
        $(document).on(
          "click",
          ".wpsbc-search-widget-datepicker-submit",
          function (e) {
            e.preventDefault();
            var $button = $(this),
              $container = $button.parents(".wpsbc-search-widget"),
              $form = $container.find(".wpsbc-search-widget-form");
            if ($container.data("redirect")) return $form.submit(), !1;
            $form.addClass("wpsbc-searching"),
              $button.prop("disabled", !0),
              $(".wpsbc-search-widget-results-wrap").empty(),
              $(".wpsbc-search-widget-error-field").empty();
            var data = {
              action: "wpsbc_search_calendars",
              start_date: $form
                .find(
                  ".wpsbc-search-widget-datepicker-standard-format-start-date"
                )
                .val(),
              end_date: $form
                .find(
                  ".wpsbc-search-widget-datepicker-standard-format-end-date"
                )
                .val(),
              args: $container.data(),
              wpsbc_token: wpsbc.search_form_nonce,
            };
            $.post(wpsbc.ajax_url, data, function (response) {
              $form.removeClass("wpsbc-searching"),
                $button.prop("disabled", !1),
                $container.replaceWith(response),
                wpsbc_search_widget_initialize_datepickers(),
                (wpsbc_pagination_total = $(
                  ".wpsbc-search-widget-result"
                ).length),
                (wpsbc_pagination_pages = Math.ceil(
                  wpsbc_pagination_total / wpsbc_pagination_ppp
                )),
                (wpsbc_pagination_current_page = 0),
                wpsbc_search_widget_pagination(),
                wpsbc_search_widget_add_padding(),
                wpsbc_search_results_widget_add_padding(),
                wpsbc_search_widget_size(),
                $(".wpsbc-search-widget").animate({ opacity: 1 }, 200);
            });
          }
        ),
        wpsbc_search_widget_add_padding(),
        wpsbc_search_results_widget_add_padding(),
        wpsbc_search_widget_size(),
        $(window).on("load", function () {
          $(".wpsbc-search-widget").animate({ opacity: 1 }, 200);
        }),
        $(window).bind("load resize", function () {
          wpsbc_search_widget_add_padding(),
            wpsbc_search_results_widget_add_padding(),
            wpsbc_search_widget_size();
        });
    });
  var wpsbc_pagination_ppp =
      Math.abs($(".wpsbc-search-widget").data("results_per_page")) > 0
        ? Math.abs($(".wpsbc-search-widget").data("results_per_page"))
        : 10,
    wpsbc_pagination_total = $(".wpsbc-search-widget-result").length,
    wpsbc_pagination_pages = Math.ceil(
      wpsbc_pagination_total / wpsbc_pagination_ppp
    ),
    wpsbc_pagination_current_page = 0;
  function wpsbc_search_widget_pagination() {
    if (
      ($(".wpsbc-search-widget-result").hide(),
      $(".wpsbc-search-widget-result")
        .slice(
          wpsbc_pagination_current_page * wpsbc_pagination_ppp,
          (wpsbc_pagination_current_page + 1) * wpsbc_pagination_ppp
        )
        .show(),
      wpsbc_pagination_total > wpsbc_pagination_ppp)
    ) {
      for (
        $(".wpsbc-search-pagination").remove(),
          $(".wpsbc-search-widget-results-wrap").append(
            '<div class="wpsbc-search-pagination"><ul></ul></div>'
          ),
          $(".wpsbc-search-pagination ul").append(
            "<li><a " +
              (0 == wpsbc_pagination_current_page
                ? 'class="wpsbc-pagination-disabled"'
                : "") +
              ' href="#" data-page="previous">' +
              $(".wpsbc-search-widget-results-wrap").data("label-previous") +
              "</a></li>"
          ),
          i = 0;
        i < wpsbc_pagination_pages;
        i++
      )
        $(".wpsbc-search-pagination ul").append(
          "<li><a " +
            (wpsbc_pagination_current_page == i
              ? 'class="wpsbc-pagination-active"'
              : "") +
            ' href="#" data-page="' +
            i +
            '">' +
            (i + 1) +
            "</a></li>"
        );
      $(".wpsbc-search-pagination ul").append(
        "<li><a " +
          (wpsbc_pagination_current_page == wpsbc_pagination_pages - 1
            ? 'class="wpsbc-pagination-disabled"'
            : "") +
          ' href="#" data-page="next">' +
          $(".wpsbc-search-widget-results-wrap").data("label-next") +
          "</a></li>"
      );
    }
  }
  function wpsbc_search_widget_initialize_datepickers() {
    if ($("body").hasClass("wp-admin")) return !1;
    "function" == typeof $.fn.datepicker.noConflict &&
      $.fn.datepicker.noConflict();
    var start_date = $(".wpsbc-search-widget-datepicker-start-date")
        .datepicker({
          changeMonth: !0,
          changeYear: !0,
          dateFormat: wpsbc.search_date_format,
          minDate: 0,
          altFormat: "yy-m-d",
          altField: $(
            ".wpsbc-search-widget-datepicker-standard-format-start-date"
          ),
          showOtherMonths: !0,
          selectOtherMonths: !0,
          beforeShow: function () {
            $("#ui-datepicker-div").addClass("wpsbc-datepicker");
          },
          onClose: function () {
            $("#ui-datepicker-div").hide().removeClass("wpsbc-datepicker"),
              $(".wpsbc-search-widget-datepicker-end-date").focus();
          },
        })
        .on("change", function () {
          end_date.datepicker(
            "option",
            "minDate",
            wpsbc_datepicker_get_date(this)
          ),
            $(".wpsbc-search-widget").data("redirect") ||
              wpsbc_datepicker_update_state(
                "wpsbc-search-start-date",
                $(
                  ".wpsbc-search-widget-datepicker-standard-format-start-date"
                ).val()
              );
        }),
      end_date = $(".wpsbc-search-widget-datepicker-end-date")
        .datepicker({
          changeMonth: !0,
          changeYear: !0,
          dateFormat: wpsbc.search_date_format,
          minDate: wpsbc_datepicker_get_date(
            $(".wpsbc-search-widget-datepicker-start-date")[0]
          ),
          altFormat: "yy-m-d",
          altField: $(
            ".wpsbc-search-widget-datepicker-standard-format-end-date"
          ),
          showOtherMonths: !0,
          selectOtherMonths: !0,
          beforeShow: function () {
            $("#ui-datepicker-div").addClass("wpsbc-datepicker");
          },
          onClose: function () {
            $("#ui-datepicker-div").hide().removeClass("wpsbc-datepicker");
          },
        })
        .on("change", function () {
          $(".wpsbc-search-widget").data("redirect") ||
            wpsbc_datepicker_update_state(
              "wpsbc-search-end-date",
              $(
                ".wpsbc-search-widget-datepicker-standard-format-end-date"
              ).val()
            );
        });
  }
  function wpsbc_datepicker_update_state(key, value) {
    var baseUrl = [
        location.protocol,
        "//",
        location.host,
        location.pathname,
      ].join(""),
      urlQueryString = document.location.search,
      newParam = key + "=" + value,
      params = "?" + newParam;
    urlQueryString &&
      ((keyRegex = new RegExp("([?&])" + key + "[^&]*")),
      (params =
        null !== urlQueryString.match(keyRegex)
          ? urlQueryString.replace(keyRegex, "$1" + newParam)
          : urlQueryString + "&" + newParam)),
      window.history.replaceState({}, "", baseUrl + params);
  }
  function wpsbc_datepicker_get_date(element) {
    var date;
    try {
      date = $.datepicker.parseDate(wpsbc.search_date_format, element.value);
    } catch (error) {
      date = null;
    }
    return date;
  }
  $("body").on("click", ".wpsbc-search-pagination li a", function (e) {
    if ((e.preventDefault(), $(this).hasClass("wpsbc-pagination-disabled")))
      return !1;
    var page = $(this).data("page");
    "next" == page &&
      wpsbc_pagination_current_page != wpsbc_pagination_pages - 1 &&
      (page = wpsbc_pagination_current_page + 1),
      "previous" == page &&
        0 != wpsbc_pagination_current_page &&
        (page = wpsbc_pagination_current_page - 1),
      (wpsbc_pagination_current_page = page),
      wpsbc_search_widget_pagination();
  }),
    $("body").hasClass("elementor-editor-active") &&
      setInterval(function () {
        $(".wpsbc-container-loaded").each(function () {
          "1" == $(this).attr("data-just-loaded") &&
            ($(window).trigger("resize"),
            $(this).attr("data-just-loaded", "0"));
        });
      }, 250),
    $(document).on("elementor/popup/show", () => {
      $(window).trigger("resize");
    });
});
